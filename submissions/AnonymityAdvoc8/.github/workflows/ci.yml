name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Code Quality Checks
  lint:
    name: Code Quality (Lint & Format)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Check code formatting with Black
        run: |
          black --check banking_client/ tests/ main.py
      
      - name: Lint with Ruff
        run: |
          ruff check banking_client/ tests/ main.py
      
      - name: Type check with MyPy
        run: |
          mypy banking_client/
        continue-on-error: true  # Don't fail build on type errors

  # Unit Tests
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Run unit tests
        run: |
          pytest tests/test_client.py tests/test_auth.py tests/test_models.py tests/test_config.py -v --cov=banking_client --cov-report=xml --cov-report=term
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # Integration Tests
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    services:
      banking-server:
        image: singhacksbjb/sidequest-server:latest
        ports:
          - 8123:8123
        options: >-
          --health-cmd "curl -f http://localhost:8123/accounts/validate/ACC1000 || exit 1"
          --health-interval 10s
          --health-timeout 3s
          --health-retries 3
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Wait for banking server
        run: |
          timeout 30 bash -c 'until curl -f http://localhost:8123/accounts/validate/ACC1000; do sleep 1; done'
      
      - name: Run integration tests
        run: |
          pytest tests/test_integration.py -v
        env:
          API_BASE_URL: http://localhost:8123

  # Docker Build
  docker:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build -t banking-client:test .
      
      - name: Test Docker image
        run: |
          docker run --rm banking-client:test --version || echo "Version check"
          docker run --rm banking-client:test --help

  # Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true

  # Summary
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint, test, integration-test, docker]
    if: always()
    
    steps:
      - name: Check build status
        run: |
          echo "âœ… CI/CD Pipeline Complete"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Integration: ${{ needs.integration-test.result }}"
          echo "Docker: ${{ needs.docker.result }}"

